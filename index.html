<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market DAO Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background-color: #f4f4f4;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        input, select, button {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Market DAO Interface</h1>

    <div id="connect-section" class="section">
        <h2>Connect Wallet</h2>
        <button id="connectButton">Connect to MetaMask</button>
    </div>

    <div id="dao-info" class="section" style="display:none;">
        <h2>DAO Information</h2>
        <p>Name: <span id="daoName"></span></p>
        <p>Token Price: <span id="tokenPrice"></span> ETH</p>
        <p>Support Threshold: <span id="supportThreshold"></span>%</p>
        <p>Quorum Percentage: <span id="quorumPercentage"></span>%</p>
        <p>Governance Token Balance: <span id="tokenBalance"></span></p>
        <button id="purchaseTokens">Purchase Tokens</button>
    </div>

    <div id="proposal-section" class="section" style="display:none;">
        <h2>Create Proposal</h2>
        <select id="proposalType">
            <option value="resolution">Resolution Proposal</option>
            <option value="treasury">Treasury Proposal</option>
            <option value="mint">Mint Proposal</option>
            <option value="price">Token Price Proposal</option>
        </select>

        <div id="proposal-details">
            <input type="text" id="description" placeholder="Proposal Description">
            
            <!-- Treasury Proposal Fields -->
            <div id="treasury-fields" style="display:none;">
                <input type="text" id="recipient" placeholder="Recipient Address">
                <input type="text" id="amount" placeholder="Amount (in ETH)">
                <input type="text" id="token" placeholder="Token Address (optional)">
                <input type="text" id="tokenId" placeholder="Token ID (optional)">
            </div>

            <!-- Mint Proposal Fields -->
            <div id="mint-fields" style="display:none;">
                <input type="text" id="mintRecipient" placeholder="Recipient Address">
                <input type="text" id="mintAmount" placeholder="Amount to Mint">
            </div>

            <!-- Price Proposal Fields -->
            <div id="price-fields" style="display:none;">
                <input type="text" id="newPrice" placeholder="New Token Price (ETH)">
            </div>
        </div>
        
        <button id="createProposal">Create Proposal</button>
    </div>

    <script>
        // Contract configuration
        const FACTORY_ADDRESS = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
        const DAO_ADDRESS = '0xd5ebe185d52486a7b4e5b957ebd44f84ffa6a5f2eae418e3821d0981642e5ee2';

        // Global application state
        const state = {
            web3: null,
            daoContract: null,
            factoryContract: null,
            userAddress: null,
            marketDaoABI: null,
            proposalFactoryABI: null
        };

        // Load ABI files
        async function loadABIs() {
            try {
                // Fetch MarketDAO ABI
                const marketDaoResponse = await fetch('MarketDAO.json');
                const marketDaoJson = await marketDaoResponse.json();
                state.marketDaoABI = marketDaoJson.abi;

                // Fetch ProposalFactory ABI
                const proposalFactoryResponse = await fetch('ProposalFactory.json');
                const proposalFactoryJson = await proposalFactoryResponse.json();
                state.proposalFactoryABI = proposalFactoryJson.abi;

                return true;
            } catch (error) {
                console.error('Failed to load ABIs:', error);
                alert('Failed to load contract ABIs. Check console for details.');
                return false;
            }
        }

        // Connect Wallet
        async function connectWallet() {
            // Ensure ABIs are loaded first
            const abisLoaded = await loadABIs();
            if (!abisLoaded) return;

            if (window.ethereum) {
                try {
                    // Initialize Web3
                    state.web3 = new Web3(window.ethereum);

                    // Request account access
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    state.userAddress = state.web3.utils.toChecksumAddress(accounts[0]);

                    // Properly checksum the addresses
                    const factoryAddress = state.web3.utils.toChecksumAddress(FACTORY_ADDRESS);
                    const daoAddress = state.web3.utils.toChecksumAddress(DAO_ADDRESS);

                    // Initialize contracts
                    state.daoContract = new state.web3.eth.Contract(
                        state.marketDaoABI, 
                        daoAddress
                    );
                    state.factoryContract = new state.web3.eth.Contract(
                        state.proposalFactoryABI, 
                        factoryAddress
                    );

                    // Fetch and display DAO info
                    await fetchDaoInfo();

                    // Show/hide sections
                    document.getElementById('connect-section').style.display = 'none';
                    document.getElementById('dao-info').style.display = 'block';
                    document.getElementById('proposal-section').style.display = 'block';
                } catch (error) {
                    console.error('Failed to connect wallet', error);
                    alert('Failed to connect wallet: ' + error.message);
                }
            } else {
                alert('Please install MetaMask!');
            }
        }

        // Fetch DAO Information
        async function fetchDaoInfo() {
            if (!state.daoContract) return;

            try {
                const name = await state.daoContract.methods.name().call();
                const tokenPrice = await state.daoContract.methods.tokenPrice().call();
                const supportThreshold = await state.daoContract.methods.supportThreshold().call();
                const quorumPercentage = await state.daoContract.methods.quorumPercentage().call();
                const tokenBalance = await state.daoContract.methods.balanceOf(state.userAddress, 0).call();

                document.getElementById('daoName').textContent = name;
                document.getElementById('tokenPrice').textContent = state.web3.utils.fromWei(tokenPrice, 'ether');
                document.getElementById('supportThreshold').textContent = supportThreshold;
                document.getElementById('quorumPercentage').textContent = quorumPercentage;
                document.getElementById('tokenBalance').textContent = tokenBalance;
            } catch (error) {
                console.error('Error fetching DAO info', error);
            }
        }

        // Purchase Tokens
        async function purchaseTokens() {
            if (!state.daoContract) return;

            try {
                const tokenPrice = await state.daoContract.methods.tokenPrice().call();
                await state.daoContract.methods.purchaseTokens().send({
                    from: state.userAddress,
                    value: tokenPrice
                });
                alert('Tokens purchased successfully!');
                await fetchDaoInfo();
            } catch (error) {
                console.error('Token purchase failed', error);
                alert('Token purchase failed: ' + error.message);
            }
        }

        // Create Proposal
        async function createProposal() {
            if (!state.factoryContract) return;

            const proposalType = document.getElementById('proposalType').value;
            const description = document.getElementById('description').value;

            try {
                switch(proposalType) {
                    case 'resolution':
                        await state.factoryContract.methods.createResolutionProposal(description)
                            .send({ from: state.userAddress });
                        break;
                    case 'treasury':
                        const recipient = document.getElementById('recipient').value;
                        const amount = state.web3.utils.toWei(document.getElementById('amount').value, 'ether');
                        const token = document.getElementById('token').value || '0x0000000000000000000000000000000000000000';
                        const tokenId = document.getElementById('tokenId').value || 0;
                        
                        await state.factoryContract.methods.createTreasuryProposal(
                            description, 
                            recipient, 
                            amount, 
                            token, 
                            tokenId
                        ).send({ from: state.userAddress });
                        break;
                    case 'mint':
                        const mintRecipient = document.getElementById('mintRecipient').value;
                        const mintAmount = state.web3.utils.toWei(document.getElementById('mintAmount').value, 'ether');
                        
                        await state.factoryContract.methods.createMintProposal(
                            description, 
                            mintRecipient, 
                            mintAmount
                        ).send({ from: state.userAddress });
                        break;
                    case 'price':
                        const newPrice = state.web3.utils.toWei(document.getElementById('newPrice').value, 'ether');
                        
                        await state.factoryContract.methods.createTokenPriceProposal(
                            description, 
                            newPrice
                        ).send({ from: state.userAddress });
                        break;
                }
                alert(`${proposalType} proposal created successfully!`);
            } catch (error) {
                console.error('Proposal creation failed', error);
                alert('Proposal creation failed: ' + error.message);
            }
        }

        // Event Listeners
        document.getElementById('connectButton').addEventListener('click', connectWallet);
        document.getElementById('purchaseTokens').addEventListener('click', purchaseTokens);
        document.getElementById('createProposal').addEventListener('click', createProposal);

        // Proposal Type Selection
        document.getElementById('proposalType').addEventListener('change', (e) => {
            // Hide all proposal-specific fields
            document.getElementById('treasury-fields').style.display = 'none';
            document.getElementById('mint-fields').style.display = 'none';
            document.getElementById('price-fields').style.display = 'none';

            // Show relevant fields based on selected proposal type
            switch(e.target.value) {
                case 'treasury':
                    document.getElementById('treasury-fields').style.display = 'block';
                    break;
                case 'mint':
                    document.getElementById('mint-fields').style.display = 'block';
                    break;
                case 'price':
                    document.getElementById('price-fields').style.display = 'block';
                    break;
            }
        });
    </script>
</body>
</html>
